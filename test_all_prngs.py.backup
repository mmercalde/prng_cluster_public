#!/usr/bin/env python3
"""
Test that sieve_filter.py works with ALL configurable PRNGs
"""
import json
import subprocess
import sys

# Get all available PRNGs
sys.path.insert(0, '.')
from prng_registry import list_available_prngs

available_prngs = list_available_prngs()
print(f"Testing {len(available_prngs)} PRNGs: {available_prngs}")
print("="*70)

results = {}

for prng in available_prngs:
    # Skip hybrid variants for now - those need special handling
    if 'hybrid' in prng or 'reverse' in prng:
        print(f"‚è≠Ô∏è  Skipping {prng} (needs special handling)")
        continue
    
    print(f"\nüî¨ Testing {prng}...")
    
    # Create job for this PRNG
    test_job = {
        "job_id": f"test_{prng}",
        "dataset_path": "test_26gpu_large.json",
        "seed_start": 0,
        "seed_end": 10000,  # Small range for quick test
        "window_size": 512,
        "min_match_threshold": 0.7,
        "skip_range": [0, 5],
        "prng_families": [prng],  # Test this specific PRNG
        "sessions": ["midday"]
    }
    
    job_file = f"test_{prng}_job.json"
    with open(job_file, 'w') as f:
        json.dump(test_job, f, indent=2)
    
    # Run sieve
    try:
        result = subprocess.run(
            ['python3', 'sieve_filter.py', '--job-file', job_file, '--gpu-id', '0'],
            capture_output=True,
            text=True,
            timeout=30
        )
        
        # Check if it mentions the correct PRNG in stderr
        if prng in result.stderr:
            print(f"   ‚úÖ {prng} - correctly used!")
            results[prng] = 'PASS'
        else:
            print(f"   ‚ö†Ô∏è  {prng} - ran but didn't see PRNG name in output")
            print(f"      stderr: {result.stderr[:200]}")
            results[prng] = 'UNCLEAR'
        
        # Check for errors
        if result.returncode != 0 and 'success": false' in result.stdout:
            output = json.loads(result.stdout)
            if 'error' in output:
                print(f"   ‚ùå {prng} - ERROR: {output['error']}")
                results[prng] = 'FAIL'
    
    except subprocess.TimeoutExpired:
        print(f"   ‚è±Ô∏è  {prng} - timeout (still running after 30s)")
        results[prng] = 'TIMEOUT'
    except Exception as e:
        print(f"   ‚ùå {prng} - EXCEPTION: {e}")
        results[prng] = 'EXCEPTION'

print("\n" + "="*70)
print("SUMMARY:")
print("="*70)
for prng, status in results.items():
    emoji = "‚úÖ" if status == "PASS" else "‚ö†Ô∏è" if status == "UNCLEAR" else "‚ùå"
    print(f"{emoji} {prng:20} {status}")

passed = sum(1 for s in results.values() if s == 'PASS')
total = len(results)
print(f"\nPassed: {passed}/{total}")

