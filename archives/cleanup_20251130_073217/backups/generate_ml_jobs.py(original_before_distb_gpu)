#!/usr/bin/env python3
"""
generate_ml_jobs.py - Generate job specs for 26-GPU Optuna training
Creates one job per trial, each will sample different hyperparameters
"""

import json
import argparse
from pathlib import Path

def main():
    parser = argparse.ArgumentParser(description='Generate ML training jobs for distributed Optuna')
    parser.add_argument('--trials', type=int, default=30, help='Number of Optuna trials')
    parser.add_argument('--survivors', required=True, help='Path to survivors JSON')
    parser.add_argument('--scores', required=True, help='Path to scores JSON')
    parser.add_argument('--study-name', required=True, help='Optuna study name')
    parser.add_argument('--study-db', required=True, help='Optuna study database URL')
    args = parser.parse_args()
    
    # Validate input files exist
    if not Path(args.survivors).exists():
        print(f"WARNING: Survivors file not found: {args.survivors}")
    if not Path(args.scores).exists():
        print(f"WARNING: Scores file not found: {args.scores}")
    
    jobs = []
    for i in range(args.trials):
        job = {
            "job_id": f"ml_trial_{i}",
            "script": "anti_overfit_trial_worker.py",
            "args": [
                args.survivors,
                args.scores,
                args.study_name,
                args.study_db,
                str(i)
            ],
            "gpu_required": True,
            "output_file": f"/shared/ml/results/trial_{i}.json",
            "timeout": 3600,
            "retry_on_failure": False
        }
        jobs.append(job)
    
    # Write job specifications
    output_file = "ml_jobs.json"
    with open(output_file, "w") as f:
        json.dump(jobs, f, indent=2)
    
    print(f"âœ… Generated {len(jobs)} job specifications")
    print(f"   Output: {output_file}")
    print(f"   Study: {args.study_name}")
    print(f"   Database: {args.study_db}")
    
    # Print first job as sample
    print(f"\nðŸ“‹ Sample job:")
    print(json.dumps(jobs[0], indent=2))

if __name__ == "__main__":
    main()
