# Training Diagnostics Analysis Grammar v1.1 - Fixed for llama.cpp (single-line rules)
# Multi-line rule definitions cause parse failures in llama.cpp
#
# Constrains LLM output to valid DiagnosticsAnalysis JSON.
# VERSION: 1.1.0
# DATE: 2026-02-12
# CHAPTER: 14 Phase 7 (LLM Integration)

root ::= analysis

analysis ::= "{" ws "\"focus_area\"" ws ":" ws focus-area "," ws "\"root_cause\"" ws ":" ws string "," ws "\"root_cause_confidence\"" ws ":" ws confidence-value "," ws "\"model_recommendations\"" ws ":" ws model-recommendations "," ws "\"parameter_proposals\"" ws ":" ws parameter-proposals "," ws "\"selfplay_guidance\"" ws ":" ws string "," ws "\"requires_human_review\"" ws ":" ws boolean ws "}"

focus-area ::= "\"MODEL_DIVERSITY\"" | "\"FEATURE_RELEVANCE\"" | "\"POOL_PRECISION\"" | "\"CONFIDENCE_CALIBRATION\"" | "\"REGIME_SHIFT\""

model-recommendations ::= "[" ws model-recommendation (ws "," ws model-recommendation)* ws "]"

model-recommendation ::= "{" ws "\"model_type\"" ws ":" ws model-type "," ws "\"verdict\"" ws ":" ws model-verdict "," ws "\"rationale\"" ws ":" ws string ws "}"

model-type ::= "\"neural_net\"" | "\"xgboost\"" | "\"lightgbm\"" | "\"catboost\""

model-verdict ::= "\"viable\"" | "\"fixable\"" | "\"skip\"" | "\"not_evaluated\""

parameter-proposals ::= "[]" | "[" ws parameter-proposal (ws "," ws parameter-proposal)* ws "]"

parameter-proposal ::= "{" ws "\"parameter\"" ws ":" ws string "," ws "\"current_value\"" ws ":" ws (number | "null") "," ws "\"proposed_value\"" ws ":" ws number "," ws "\"rationale\"" ws ":" ws string ws "}"

confidence-value ::= "0" ("." [0-9]+)? | "1" (".0")? | "0." [0-9]+

boolean ::= "true" | "false"

number ::= "-"? [0-9]+ ("." [0-9]+)?

string ::= "\"" string-content "\""
string-content ::= ([^"\\] | "\\" ["\\/bfnrt])*

ws ::= [ \t\n]*
