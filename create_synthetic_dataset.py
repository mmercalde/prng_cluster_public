#!/usr/bin/env python3
"""
Create synthetic lottery dataset generated by known PRNG seeds.
Separate seeds for midday and evening sessions.

Usage:
  python3 create_synthetic_dataset.py --seed-midday 42 --seed-evening 1337 --prng xorshift32 --count 10000 --skip 5 --out synthetic_dual.json
"""

import argparse
import json
from datetime import datetime, timedelta

def xorshift32_step(state: int) -> int:
    """Single xorshift32 step"""
    x = state & 0xFFFFFFFF
    x ^= (x << 13) & 0xFFFFFFFF
    x ^= (x >> 17) & 0xFFFFFFFF
    x ^= (x << 5) & 0xFFFFFFFF
    return x & 0xFFFFFFFF

def generate_draws(seed: int, count: int, skip: int = 0) -> list:
    """Generate draws from PRNG with optional skip (verification runs)"""
    state = seed
    draws = []
    
    for i in range(count):
        # Advance state (skip+1) steps per draw
        for _ in range(skip + 1):
            state = xorshift32_step(state)
        
        # Output is state % 1000
        draw = state % 1000
        draws.append(draw)
    
    return draws

def create_dataset(midday_draws: list, evening_draws: list, start_date: str = "2020-01-01") -> list:
    """Create lottery dataset with separate sequences for midday/evening"""
    dataset = []
    current_date = datetime.strptime(start_date, "%Y-%m-%d")
    
    # Interleave midday and evening draws
    for i in range(min(len(midday_draws), len(evening_draws))):
        # Midday
        dataset.append({
            "date": current_date.strftime("%Y-%m-%d"),
            "session": "midday",
            "draw": midday_draws[i]
        })
        
        # Evening
        dataset.append({
            "date": current_date.strftime("%Y-%m-%d"),
            "session": "evening",
            "draw": evening_draws[i]
        })
        
        # Next day
        current_date += timedelta(days=1)
    
    return dataset

def main():
    ap = argparse.ArgumentParser(description="Create synthetic lottery dataset with separate PRNG seeds per session")
    ap.add_argument("--seed-midday", type=int, default=42, help="PRNG seed for midday (default: 42)")
    ap.add_argument("--seed-evening", type=int, default=1337, help="PRNG seed for evening (default: 1337)")
    ap.add_argument("--prng", default="xorshift32", help="PRNG type (currently only xorshift32)")
    ap.add_argument("--count", type=int, default=10000, help="Number of draws per session")
    ap.add_argument("--skip", type=int, default=5, help="Skip value (verification runs)")
    ap.add_argument("--start-date", default="2020-01-01", help="Start date YYYY-MM-DD")
    ap.add_argument("--out", default="synthetic_dual.json", help="Output JSON file")
    args = ap.parse_args()
    
    if args.prng != "xorshift32":
        print("ERROR: Only xorshift32 currently supported")
        return 1
    
    print(f"\nCreating Synthetic Dataset (Dual Sequence)")
    print("=" * 60)
    print(f"PRNG: {args.prng}")
    print(f"Midday seed: {args.seed_midday}")
    print(f"Evening seed: {args.seed_evening}")
    print(f"Skip: {args.skip}")
    print(f"Count per session: {args.count:,} draws")
    print(f"Total draws: {args.count * 2:,}")
    print(f"Start date: {args.start_date}")
    
    # Generate separate sequences
    print(f"\nGenerating midday draws from seed {args.seed_midday}...")
    midday_draws = generate_draws(args.seed_midday, args.count, args.skip)
    
    print(f"Generating evening draws from seed {args.seed_evening}...")
    evening_draws = generate_draws(args.seed_evening, args.count, args.skip)
    
    # Create dataset with interleaved sessions
    print(f"Creating dataset structure...")
    dataset = create_dataset(midday_draws, evening_draws, args.start_date)
    
    # Save
    with open(args.out, 'w') as f:
        json.dump(dataset, f, indent=2)
    
    print(f"\n✓ Created {len(dataset):,} entries")
    print(f"  Date range: {dataset[0]['date']} to {dataset[-1]['date']}")
    print(f"  Sessions: {args.count:,} midday + {args.count:,} evening")
    print(f"  Output: {args.out}")
    
    # Verification
    print(f"\nVerification (first draws):")
    
    # Midday
    state = args.seed_midday
    for _ in range(args.skip + 1):
        state = xorshift32_step(state)
    expected_midday = state % 1000
    actual_midday = dataset[0]['draw']
    print(f"  Midday: Seed {args.seed_midday} → {args.skip+1} steps → {expected_midday}")
    print(f"          First draw: {actual_midday} | Match: {'✓' if expected_midday == actual_midday else '✗'}")
    
    # Evening
    state = args.seed_evening
    for _ in range(args.skip + 1):
        state = xorshift32_step(state)
    expected_evening = state % 1000
    actual_evening = dataset[1]['draw']
    print(f"  Evening: Seed {args.seed_evening} → {args.skip+1} steps → {expected_evening}")
    print(f"           First draw: {actual_evening} | Match: {'✓' if expected_evening == actual_evening else '✗'}")
    
    return 0

if __name__ == "__main__":
    exit(main())
