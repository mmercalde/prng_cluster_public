# Chapter 13 LLM Proposal Grammar
# GBNF grammar for llama.cpp grammar-constrained decoding
#
# This grammar ensures the LLM produces valid JSON matching
# the LLMProposal schema defined in llm_proposal_schema.py
#
# VERSION: 1.0.0
# DATE: 2026-01-12
#
# Usage with llama.cpp:
#   --grammar-file chapter_13.gbnf
#
# Usage with LLMRouter:
#   router.evaluate_with_grammar(prompt, grammar_file="chapter_13.gbnf")

# Root rule - complete proposal object
root ::= proposal

# Main proposal object
proposal ::= "{" ws
    "\"analysis_summary\"" ws ":" ws string "," ws
    "\"failure_mode\"" ws ":" ws failure-mode "," ws
    "\"confidence\"" ws ":" ws confidence-value "," ws
    "\"recommended_action\"" ws ":" ws recommended-action "," ws
    "\"retrain_scope\"" ws ":" ws (retrain-scope | "null") "," ws
    "\"parameter_proposals\"" ws ":" ws parameter-proposals "," ws
    "\"risk_level\"" ws ":" ws risk-level "," ws
    "\"requires_human_review\"" ws ":" ws boolean "," ws
    "\"alternative_hypothesis\"" ws ":" ws (string | "null")
    ws "}"

# Failure mode enum
failure-mode ::= "\"calibration_drift\"" |
                 "\"feature_relevance\"" |
                 "\"window_misalignment\"" |
                 "\"random_variance\"" |
                 "\"regime_shift\"" |
                 "\"model_overfit\"" |
                 "\"data_quality\"" |
                 "\"none_detected\""

# Recommended action enum
recommended-action ::= "\"RETRAIN\"" |
                       "\"WAIT\"" |
                       "\"ESCALATE\"" |
                       "\"FULL_RESET\""

# Retrain scope enum
retrain-scope ::= "\"steps_3_5_6\"" |
                  "\"steps_5_6\"" |
                  "\"step_6_only\"" |
                  "\"full_pipeline\""

# Risk level enum
risk-level ::= "\"low\"" |
               "\"medium\"" |
               "\"high\""

# Confidence value (0.0 to 1.0)
confidence-value ::= "0" ("." [0-9]+)? |
                     "1" (".0")?  |
                     "0." [0-9]+

# Parameter proposals array (0-5 items)
parameter-proposals ::= "[]" |
                        "[" ws parameter-proposal (ws "," ws parameter-proposal)* ws "]"

# Single parameter proposal
parameter-proposal ::= "{" ws
    "\"parameter\"" ws ":" ws string "," ws
    "\"current_value\"" ws ":" ws (number | "null") "," ws
    "\"proposed_value\"" ws ":" ws number "," ws
    "\"delta\"" ws ":" ws delta-string "," ws
    "\"confidence\"" ws ":" ws confidence-value "," ws
    "\"rationale\"" ws ":" ws string
    ws "}"

# Delta string (e.g., "+0.05", "-10", "*1.2")
delta-string ::= "\"" delta-content "\""
delta-content ::= ("+" | "-" | "*")? [0-9]+ ("." [0-9]+)?

# Boolean
boolean ::= "true" | "false"

# Number (integer or float)
number ::= "-"? [0-9]+ ("." [0-9]+)?

# String (JSON string)
string ::= "\"" string-content "\""
string-content ::= ([^"\\] | "\\" ["\\/bfnrt])*

# Whitespace
ws ::= [ \t\n\r]*
